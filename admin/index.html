<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <style>
    :root { --text:#111; --muted:#6c717c; --btn:#d1a739; --btn2:#222327; }
    body{margin:0;background:#eef0f3;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:2.5rem auto;padding:0 1rem}
    h1{margin:.25rem 0 1rem}
    p.muted{color:var(--muted)}
    .bar{display:flex;gap:.5rem;flex-wrap:wrap;margin:1rem 0 1.25rem}
    .btn{appearance:none;border:0;border-radius:12px;padding:.6rem .9rem;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--btn);color:#111}
    .btn-ghost{background:var(--btn2);color:#fff;border:1px solid #2e2f33}
    a.btn{display:inline-block;text-decoration:none}
    code{background:#1a1b1f;color:#eaeaea;padding:.1rem .35rem;border-radius:6px}
    #nc-root{background:#111;border:1px solid #1f2024;border-radius:14px;overflow:hidden}
  </style>

  <!-- Tell CMS we will initialize it manually (so it won't fetch /admin/config.yml) -->
  <script>window.CMS_MANUAL_INIT = true;</script>
</head>
<body>
  <div class="wrap">
    <h1>Admin</h1>
    <p class="muted">
      Upload photos to the gallery. After you publish/deploy, new images appear on
      <a href="/gallery.html">Gallery</a>. Files are saved to <code>static/uploads/</code>.
    </p>

    <div class="bar">
      <a class="btn btn-primary" id="open-media" href="#/media">Open Media Library</a>
      <a class="btn btn-ghost" href="/gallery.html" target="_blank" rel="noopener">View Gallery</a>
      <button class="btn btn-ghost" id="login-btn" hidden>Log in</button>
      <button class="btn btn-ghost" id="logout-btn" hidden>Log out</button>
    </div>

    <!-- Netlify CMS mounts here -->
    <div id="nc-root"></div>
  </div>

  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Decap/Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>

  <script>
    // ---------- Identity: auto-login + invite signup ----------
    (function () {
      if (!window.netlifyIdentity) return;

      const loginBtn  = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const setButtons = (user) => { loginBtn.hidden = !!user; logoutBtn.hidden = !user; };

      netlifyIdentity.on('init', (user) => {
        setButtons(user);
        const invited = location.hash.includes('invite_token') || location.search.includes('invite_token');
        if (invited) { netlifyIdentity.open('signup'); return; }
        if (!user) { netlifyIdentity.open('login'); } else { goMedia(); }
      });

      netlifyIdentity.on('login', () => { setButtons(netlifyIdentity.currentUser()); goMedia(true); });
      netlifyIdentity.on('logout', () => { setButtons(null); location.reload(); });

      loginBtn.addEventListener('click', () => netlifyIdentity.open('login'));
      logoutBtn.addEventListener('click', () => netlifyIdentity.logout());

      function goMedia(reload){
        location.hash = '#/media';
        document.getElementById('nc-root')?.scrollIntoView({behavior:'smooth'});
        if (reload) location.reload(); // lets CMS pick up the new session
      }
    })();

    // ---------- Initialize CMS with an embedded config ----------
    // This avoids loading /admin/config.yml (which is what's stuck on your site)
    CMS.init({
      config: {
        backend: { name: 'git-gateway', branch: 'main' },
        media_folder: 'static/uploads',
        public_folder: '/static/uploads',
        publish_mode: 'editorial_workflow',
        locale: 'en',

        // Minimal collection just to satisfy CMS; you won't use it.
        collections: [
          {
            name: 'notes',
            label: 'Notes (ignore)',
            files: [{
              file: 'admin/README.md',
              label: 'Dashboard Info',
              name: 'readme',
              editor: { preview: false },
              fields: [
                { label: 'Content', name: 'body', widget: 'markdown',
                  default: 'Use **Open Media Library** to upload or delete photos. After publish/deploy, the gallery updates automatically from /static/uploads/.' }
              ]
            }]
          }
        ]
      }
    });

    // Ensure the “Open Media Library” button scrolls to CMS area
    (function () {
      const link = document.getElementById('open-media');
      link.addEventListener('click', () => {
        setTimeout(() => document.getElementById('nc-root')?.scrollIntoView({behavior:'smooth'}), 0);
      });
      window.addEventListener('load', () => {
        if (window.netlifyIdentity?.currentUser()) location.hash = '#/media';
      });
    })();
  </script>
</body>
</html>
